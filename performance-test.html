<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Safe-Web Performance Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
      }
      .metrics-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
      .metric-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .metric-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }
      .metric-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
      }
      .metric-unit {
        font-size: 14px;
        color: #666;
      }
      .test-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }
      .sensitive-data {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .control-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }
      button:hover {
        background: #5a6fd8;
      }
      #performanceLog {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
      }
      .warning-banner {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }
      .warning-banner div {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .warning-banner span {
        font-size: 20px;
      }
      .warning-banner p {
        margin: 5px 0 0 0;
        color: #856404;
      }
      .warning-banner a {
        color: #856404;
        text-decoration: underline;
      }
      #extensionHelp {
        display: none;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      #extensionHelp h4 {
        margin-top: 0;
        color: #155724;
      }
      #extensionHelp ol {
        color: #155724;
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üî¨ Safe-Web Performance Benchmark</h1>
      <p>
        Measure extension performance, memory usage, and optimization impact
      </p>
    </div>

    <div
      id="extensionWarning"
      class="warning-banner"
      style="
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      "
    >
      <div style="display: flex; align-items: center; gap: 10px">
        <span style="font-size: 20px">‚ö†Ô∏è</span>
        <div>
          <strong>Extension Not Detected</strong>
          <p style="margin: 5px 0 0 0; color: #856404">
            For full functionality, ensure the Safe-Web extension is loaded and
            this page is accessed properly.
            <a
              href="#"
              onclick="showExtensionHelp()"
              style="color: #856404; text-decoration: underline"
              >Click here for help</a
            >
          </p>
        </div>
      </div>
    </div>

    <div
      id="extensionHelp"
      style="
        display: none;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      "
    >
      <h4 style="margin-top: 0; color: #155724">üìã Setup Instructions:</h4>
      <ol style="color: #155724; margin-bottom: 0">
        <li>Load the Safe-Web extension in Chrome Developer Mode</li>
        <li>
          Access this page via local server:
          <code>python3 -m http.server 8080</code>
        </li>
        <li>Visit: <code>http://localhost:8080/performance-test.html</code></li>
        <li>Ensure the extension has content script permissions</li>
      </ol>
    </div>

    <div class="metrics-container">
      <div class="metric-card">
        <div class="metric-title">‚ö° Scan Performance</div>
        <div class="metric-value" id="avgScanTime">0</div>
        <div class="metric-unit">ms average scan time</div>
        <div class="metric-value" id="totalScans">0</div>
        <div class="metric-unit">total scans performed</div>
      </div>

      <div class="metric-card">
        <div class="metric-title">üß† Memory Usage</div>
        <div class="metric-value" id="memoryUsage">0</div>
        <div class="metric-unit">MB heap usage</div>
        <div class="metric-value" id="nodesProcessed">0</div>
        <div class="metric-unit">DOM nodes processed</div>
      </div>
    </div>

    <div class="control-panel">
      <h3>Performance Tests</h3>
      <button onclick="startBenchmark()">üöÄ Start Benchmark</button>
      <button onclick="stressTest()">üí™ Stress Test</button>
      <button onclick="memoryTest()">üß† Memory Test</button>
      <button onclick="clearMetrics()">üßπ Clear Metrics</button>
      <button onclick="exportResults()">üìä Export Results</button>

      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
      </div>
    </div>

    <div class="test-content">
      <h3>Test Content (Contains Sensitive Data)</h3>

      <div class="sensitive-data">
        <h4>üìß Email Addresses:</h4>
        <p>
          Contact john.doe@example.com for support or reach out to
          admin@company.org for urgent matters. You can also email
          support@website.com for technical issues.
        </p>
      </div>

      <div class="sensitive-data">
        <h4>üìû Phone Numbers:</h4>
        <p>
          Call us at (555) 123-4567 or +1-800-555-0199. Emergency contact: 911.
          Office: (555) 987-6543.
        </p>
      </div>

      <div class="sensitive-data">
        <h4>üí≥ Credit Card Numbers:</h4>
        <p>
          Test cards: 4532-1234-5678-9012, 5555-4444-3333-2222, 3782 822463
          10005, 6011-1111-1111-1117
        </p>
      </div>

      <div class="sensitive-data">
        <h4>üÜî Social Security Numbers:</h4>
        <p>SSN examples: 123-45-6789, 987-65-4321, 555-44-3333</p>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-title">üìä Performance Log</div>
      <div id="performanceLog">Waiting for performance data...</div>
    </div>

    <script>
      let benchmarkData = [];
      let testRunning = false;

      // Performance monitoring
      function updateMetrics() {
        // Check if running in extension context
        if (
          typeof chrome === "undefined" ||
          !chrome.runtime ||
          !chrome.runtime.sendMessage
        ) {
          showExtensionNotDetected("Chrome extension APIs not available");
          return;
        }

        // Hide warning banner if extension APIs are available
        document.getElementById("extensionWarning").style.display = "none";
        document.getElementById("extensionHelp").style.display = "none";

        chrome.runtime.sendMessage(
          { type: "GET_GLOBAL_PERFORMANCE" },
          (response) => {
            if (chrome.runtime.lastError) {
              const error = chrome.runtime.lastError.message;
              console.warn("Extension communication error:", error);

              if (
                error.includes("message port closed") ||
                error.includes("Receiving end does not exist")
              ) {
                showExtensionNotDetected(
                  "Extension not loaded or needs reload"
                );
              } else {
                showExtensionNotDetected(`Communication error: ${error}`);
              }
              return;
            }

            if (response && response.success && response.data) {
              hideExtensionWarning();
              displayPerformanceData(response.data);
            } else {
              showExtensionNotDetected(
                "Extension not responding with valid data"
              );
            }
          }
        );
      }

      function showExtensionNotDetected(reason) {
        document.getElementById("extensionWarning").style.display = "block";
        document.getElementById("avgScanTime").textContent = "N/A";
        document.getElementById("totalScans").textContent = "N/A";
        document.getElementById("nodesProcessed").textContent = "N/A";
        document.getElementById("memoryUsage").textContent = "N/A";
        document.getElementById("performanceLog").textContent =
          `‚ö†Ô∏è Extension not detected: ${reason}\n\n` +
          "Troubleshooting:\n" +
          "1. Ensure Safe-Web extension is loaded in Chrome\n" +
          "2. Check extension is enabled and has permissions\n" +
          "3. Try reloading the extension\n" +
          "4. Verify this page is accessed via localhost:8080\n" +
          "5. Check browser console for errors";
      }

      function hideExtensionWarning() {
        document.getElementById("extensionWarning").style.display = "none";
        document.getElementById("extensionHelp").style.display = "none";
      }

      function displayPerformanceData(data) {
        if (data.average) {
          document.getElementById("avgScanTime").textContent =
            data.average.avgScanTime.toFixed(2);
          document.getElementById("totalScans").textContent =
            data.average.totalScans;
          document.getElementById("nodesProcessed").textContent =
            data.average.totalNodes;
        }

        if (data.global && data.global.memoryUsage) {
          document.getElementById("memoryUsage").textContent =
            data.global.memoryUsage.toFixed(2);
        }

        document.getElementById("performanceLog").textContent = JSON.stringify(
          data,
          null,
          2
        );
      }

      // Benchmark test
      async function startBenchmark() {
        if (testRunning) return;
        testRunning = true;

        const startTime = performance.now();
        const progressBar = document.getElementById("progressBar");

        console.log("üöÄ Starting Safe-Web Benchmark...");

        // Simulate various scenarios
        for (let i = 0; i < 10; i++) {
          await new Promise((resolve) => setTimeout(resolve, 1000));
          progressBar.style.width = `${(i + 1) * 10}%`;

          // Add dynamic content to trigger scans
          addTestContent(i);
          updateMetrics();
        }

        const endTime = performance.now();
        const duration = endTime - startTime;

        benchmarkData.push({
          type: "benchmark",
          duration: duration,
          timestamp: new Date().toISOString(),
        });

        console.log(`‚úÖ Benchmark completed in ${duration.toFixed(2)}ms`);
        testRunning = false;
        progressBar.style.width = "0%";
      }

      // Stress test with lots of content
      async function stressTest() {
        if (testRunning) return;
        testRunning = true;

        console.log("üí™ Starting Stress Test...");
        const progressBar = document.getElementById("progressBar");

        const startMemory = performance.memory
          ? performance.memory.usedJSHeapSize
          : 0;

        for (let i = 0; i < 50; i++) {
          addRandomSensitiveData();
          progressBar.style.width = `${(i + 1) * 2}%`;

          if (i % 10 === 0) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            updateMetrics();
          }
        }

        const endMemory = performance.memory
          ? performance.memory.usedJSHeapSize
          : 0;
        const memoryDelta = (endMemory - startMemory) / 1024 / 1024;

        benchmarkData.push({
          type: "stress",
          memoryDelta: memoryDelta,
          itemsAdded: 50,
          timestamp: new Date().toISOString(),
        });

        console.log(
          `‚úÖ Stress test completed. Memory delta: ${memoryDelta.toFixed(2)}MB`
        );
        testRunning = false;
        progressBar.style.width = "0%";
      }

      // Memory usage test
      async function memoryTest() {
        if (testRunning) return;
        testRunning = true;

        console.log("üß† Starting Memory Test...");
        const progressBar = document.getElementById("progressBar");

        const measurements = [];

        for (let i = 0; i < 20; i++) {
          const beforeMemory = performance.memory
            ? performance.memory.usedJSHeapSize
            : 0;

          // Add content
          addTestContent(i);

          await new Promise((resolve) => setTimeout(resolve, 500));

          const afterMemory = performance.memory
            ? performance.memory.usedJSHeapSize
            : 0;

          measurements.push({
            iteration: i,
            memoryBefore: beforeMemory / 1024 / 1024,
            memoryAfter: afterMemory / 1024 / 1024,
            delta: (afterMemory - beforeMemory) / 1024 / 1024,
          });

          progressBar.style.width = `${(i + 1) * 5}%`;
          updateMetrics();
        }

        benchmarkData.push({
          type: "memory",
          measurements: measurements,
          timestamp: new Date().toISOString(),
        });

        console.log("‚úÖ Memory test completed");
        testRunning = false;
        progressBar.style.width = "0%";
      }

      function addTestContent(iteration) {
        const testArea = document.querySelector(".test-content");
        const newDiv = document.createElement("div");
        newDiv.className = "sensitive-data";
        newDiv.innerHTML = `
                <h4>üìù Dynamic Content ${iteration}</h4>
                <p>Email: test${iteration}@example.com | Phone: (555) ${
          Math.floor(Math.random() * 900) + 100
        }-${Math.floor(Math.random() * 9000) + 1000}</p>
                <p>Card: 4532-${Math.floor(Math.random() * 9000) + 1000}-${
          Math.floor(Math.random() * 9000) + 1000
        }-${Math.floor(Math.random() * 9000) + 1000}</p>
            `;
        testArea.appendChild(newDiv);
      }

      function addRandomSensitiveData() {
        const testArea = document.querySelector(".test-content");
        const emails = [
          "user@test.com",
          "admin@example.org",
          "support@site.net",
        ];
        const phones = ["(555) 123-4567", "+1-800-555-0123", "555-987-6543"];

        const span = document.createElement("span");
        span.innerHTML = `${
          emails[Math.floor(Math.random() * emails.length)]
        } ${phones[Math.floor(Math.random() * phones.length)]} `;
        testArea.appendChild(span);
      }

      function clearMetrics() {
        document.getElementById("avgScanTime").textContent = "0";
        document.getElementById("totalScans").textContent = "0";
        document.getElementById("memoryUsage").textContent = "0";
        document.getElementById("nodesProcessed").textContent = "0";
        document.getElementById("performanceLog").textContent =
          "Metrics cleared...";
        benchmarkData = [];
      }

      function exportResults() {
        const data = {
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          benchmarkData: benchmarkData,
          currentMetrics: {
            avgScanTime: document.getElementById("avgScanTime").textContent,
            totalScans: document.getElementById("totalScans").textContent,
            memoryUsage: document.getElementById("memoryUsage").textContent,
            nodesProcessed:
              document.getElementById("nodesProcessed").textContent,
          },
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `safe-web-performance-${new Date()
          .toISOString()
          .slice(0, 19)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Helper functions
      function showExtensionHelp() {
        const helpDiv = document.getElementById("extensionHelp");
        helpDiv.style.display =
          helpDiv.style.display === "none" ? "block" : "none";
      }

      // Test extension connection
      function testExtensionConnection() {
        console.log("üß™ Testing Safe-Web extension connection...");

        if (typeof chrome === "undefined") {
          console.error("‚ùå Chrome APIs not available");
          return false;
        }

        if (!chrome.runtime) {
          console.error("‚ùå chrome.runtime not available");
          return false;
        }

        chrome.runtime.sendMessage({ type: "GET_SETTINGS" }, (response) => {
          if (chrome.runtime.lastError) {
            console.error(
              "‚ùå Extension communication failed:",
              chrome.runtime.lastError.message
            );
          } else if (response && response.success) {
            console.log("‚úÖ Extension connection successful!");
            console.log("Extension settings:", response.data);
          } else {
            console.error(
              "‚ùå Extension responded but with invalid data:",
              response
            );
          }
        });

        return true;
      }

      // Console helpers for debugging
      window.safeWebDebug = {
        testConnection: testExtensionConnection,
        updateMetrics: updateMetrics,
        checkExtension: () => {
          console.log("Chrome object:", !!window.chrome);
          console.log("Runtime object:", !!window.chrome?.runtime);
          console.log(
            "SendMessage function:",
            !!window.chrome?.runtime?.sendMessage
          );
        },
      };

      console.log(
        "Safe-Web Performance Test loaded. Use safeWebDebug.testConnection() to test extension."
      );

      // Auto-update metrics every 5 seconds
      setInterval(updateMetrics, 5000);
      updateMetrics(); // Initial load
    </script>
  </body>
</html>
